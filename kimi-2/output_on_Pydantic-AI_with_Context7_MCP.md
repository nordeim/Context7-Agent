Based on the latest Pydantic AI documentation, here's a comprehensive guide for building AI agents with OpenAI as the LLM and Context7 as a document retrieval tool using MCP:                                                           │
                                                                                                                                                                                                                                         │
## Installation                                                                                                                                                                                                                          │
                                                                                                                                                                                                                                         │
First, install the required packages:                                                                                                                                                                                                    │
                                                                                                                                                                                                                                         │
```bash                                                                                                                                                                                                                                  │
pip install "pydantic-ai-slim"                                                                                                                                                                                                           │
```                                                                                                                                                                                                                                      │
                                                                                                                                                                                                                                         │
## Basic Setup with OpenAI                                                                                                                                                                                                               │
                                                                                                                                                                                                                                         │
### Environment Configuration                                                                                                                                                                                                            │
Set your OpenAI API key:                                                                                                                                                                                                                 │
```bash                                                                                                                                                                                                                                  │
export OPENAI_API_KEY='your-openai-api-key'                                                                                                                                                                                              │
```                                                                                                                                                                                                                                      │
                                                                                                                                                                                                                                         │
### Simple Agent Initialization                                                                                                                                                                                                          │
```python                                                                                                                                                                                                                                │
from pydantic_ai import Agent                                                                                                                                                                                                            │
                                                                                                                                                                                                                                         │
# Initialize agent with OpenAI GPT-4o                                                                                                                                                                                                    │
agent = Agent('openai:gpt-4o')                                                                                                                                                                                                           │
```                                                                                                                                                                                                                                      │
                                                                                                                                                                                                                                         │
### Advanced OpenAI Configuration                                                                                                                                                                                                        │
```python                                                                                                                                                                                                                                │
from pydantic_ai import Agent                                                                                                                                                                                                            │
from pydantic_ai.models.openai import OpenAIModel, OpenAIResponsesModel                                                                                                                                                                  │
from pydantic_ai.providers.openai import OpenAIProvider                                                                                                                                                                                  │
                                                                                                                                                                                                                                         │
# Using OpenAIModel with custom configuration                                                                                                                                                                                            │
model = OpenAIModel(                                                                                                                                                                                                                     │
    'gpt-4o',                                                                                                                                                                                                                            │
    provider=OpenAIProvider(api_key='your-api-key')                                                                                                                                                                                      │
)                                                                                                                                                                                                                                        │
agent = Agent(model)                                                                                                                                                                                                                     │
                                                                                                                                                                                                                                         │
# Using OpenAI Responses API                                                                                                                                                                                                             │
from pydantic_ai.models.openai import OpenAIResponsesModel                                                                                                                                                                               │
responses_model = OpenAIResponsesModel('gpt-4o')                                                                                                                                                                                         │
agent = Agent(responses_model)                                                                                                                                                                                                           │
```                                                                                                                                                                                                                                      │
                                                                                                                                                                                                                                         │
## MCP Integration with Context7                                                                                                                                                                                                         │
                                                                                                                                                                                                                                         │
### Setting up MCP Client                                                                                                                                                                                                                │
Pydantic AI supports MCP (Model Context Protocol) for connecting to external tools like Context7. Here are the key approaches:                                                                                                           │
                                                                                                                                                                                                                                         │
#### HTTP SSE Transport                                                                                                                                                                                                                  │
```python                                                                                                                                                                                                                                │
from pydantic_ai import Agent                                                                                                                                                                                                            │
from pydantic_ai.mcp import MCPServerHTTP                                                                                                                                                                                                │
                                                                                                                                                                                                                                         │
# Connect to Context7 MCP server via HTTP SSE                                                                                                                                                                                            │
context7_server = MCPServerHTTP(                                                                                                                                                                                                         │
    url='http://localhost:3001/sse',  # Context7 MCP endpoint                                                                                                                                                                            │
    tool_prefix='context7'  # Prefix tools to avoid conflicts                                                                                                                                                                            │
)                                                                                                                                                                                                                                        │
                                                                                                                                                                                                                                         │
agent = Agent('openai:gpt-4o', mcp_servers=)                                                                                                                                                                                             │
                                                                                                                                                                                                                                         │
async def main():                                                                                                                                                                                                                        │
    async with agent.run_mcp_servers():                                                                                                                                                                                                  │
        result = await agent.run(                                                                                                                                                                                                        │
            'Find the latest documentation for FastAPI authentication'                                                                                                                                                                   │
        )                                                                                                                                                                                                                                │
    print(result.output)                                                                                                                                                                                                                 │
```                                                                                                                                                                                                                                      │
                                                                                                                                                                                                                                         │
#### Stdio Transport                                                                                                                                                                                                                     │
```python                                                                                                                                                                                                                                │
from pydantic_ai import Agent                                                                                                                                                                                                            │
from pydantic_ai.mcp import MCPServerStdio                                                                                                                                                                                               │
                                                                                                                                                                                                                                         │
# Connect to Context7 via stdio                                                                                                                                                                                                          │
context7_server = MCPServerStdio(                                                                                                                                                                                                        │
    'deno',                                                                                                                                                                                                                              │
    args=[                                                                                                                                                                                                                               │
        'run',                                                                                                                                                                                                                           │
        '-N',                                                                                                                                                                                                                            │
        '-R=node_modules',                                                                                                                                                                                                               │
        '-W=node_modules',                                                                                                                                                                                                               │
        '--node-modules-dir=auto',                                                                                                                                                                                                       │
        'jsr:@context7/mcp-server',                                                                                                                                                                                                      │
        'stdio',                                                                                                                                                                                                                         │
    ],                                                                                                                                                                                                                                   │
    tool_prefix='context7'                                                                                                                                                                                                               │
)                                                                                                                                                                                                                                        │
                                                                                                                                                                                                                                         │
agent = Agent('openai:gpt-4o', mcp_servers=)                                                                                                                                                                                             │
```                                                                                                                                                                                                                                      │
                                                                                                                                                                                                                                         │
## Advanced Agent Configuration                                                                                                                                                                                                          │
                                                                                                                                                                                                                                         │
### Structured Output with Dependencies                                                                                                                                                                                                  │
```python                                                                                                                                                                                                                                │
from dataclasses import dataclass                                                                                                                                                                                                        │
import httpx                                                                                                                                                                                                                             │
from pydantic_ai import Agent, RunContext                                                                                                                                                                                                │
                                                                                                                                                                                                                                         │
@dataclass                                                                                                                                                                                                                               │
class SearchDeps:                                                                                                                                                                                                                        │
    http_client: httpx.AsyncClient                                                                                                                                                                                                       │
    context7_api_key: str                                                                                                                                                                                                                │
                                                                                                                                                                                                                                         │
# Agent with Context7 integration                                                                                                                                                                                                        │
search_agent = Agent(                                                                                                                                                                                                                    │
    'openai:gpt-4o',                                                                                                                                                                                                                     │
    deps_type=SearchDeps,                                                                                                                                                                                                                │
    system_prompt='Use Context7 to find accurate documentation and provide concise answers'                                                                                                                                              │
)                                                                                                                                                                                                                                        │
                                                                                                                                                                                                                                         │
@search_agent.tool                                                                                                                                                                                                                       │
async def search_documentation(                                                                                                                                                                                                          │
    ctx: RunContext[SearchDeps],                                                                                                                                                                                                         │
    query: str                                                                                                                                                                                                                           │
) -> str:                                                                                                                                                                                                                                │
    """Search for documentation using Context7"""                                                                                                                                                                                        │
    # This would integrate with Context7 MCP tools                                                                                                                                                                                       │
    response = await ctx.deps.http_client.post(                                                                                                                                                                                          │
        'http://localhost:3001/search',                                                                                                                                                                                                  │
        json={'query': query},                                                                                                                                                                                                           │
        headers={'Authorization': f'Bearer {ctx.deps.context7_api_key}'}                                                                                                                                                                 │
    )                                                                                                                                                                                                                                    │
    return response.json()['results']                                                                                                                                                                                                    │
```                                                                                                                                                                                                                                      │
                                                                                                                                                                                                                                         │
### Multi-Agent System with Context7                                                                                                                                                                                                     │
```python                                                                                                                                                                                                                                │
from pydantic_ai import Agent                                                                                                                                                                                                            │
                                                                                                                                                                                                                                         │
# Research agent with Context7                                                                                                                                                                                                           │
research_agent = Agent(                                                                                                                                                                                                                  │
    'openai:gpt-4o',                                                                                                                                                                                                                     │
    mcp_servers=,                                                                                                                                                                                                                        │
    system_prompt='Research technical documentation using Context7'                                                                                                                                                                      │
)                                                                                                                                                                                                                                        │
                                                                                                                                                                                                                                         │
# Analysis agent                                                                                                                                                                                                                         │
analysis_agent = Agent(                                                                                                                                                                                                                  │
    'openai:gpt-4o',                                                                                                                                                                                                                     │
    system_prompt='Analyze the provided documentation and create summaries'                                                                                                                                                              │
)                                                                                                                                                                                                                                        │
                                                                                                                                                                                                                                         │
# Chain agents together                                                                                                                                                                                                                  │
async def research_and_analyze(topic: str):                                                                                                                                                                                              │
    # First, research using Context7                                                                                                                                                                                                     │
    research_result = await research_agent.run(                                                                                                                                                                                          │
        f'Find comprehensive documentation about {topic}'                                                                                                                                                                                │
    )                                                                                                                                                                                                                                    │
                                                                                                                                                                                                                                         │
    # Then analyze the findings                                                                                                                                                                                                          │
    analysis_result = await analysis_agent.run(                                                                                                                                                                                          │
        f'Analyze this documentation: {research_result.output}'                                                                                                                                                                          │
    )                                                                                                                                                                                                                                    │
                                                                                                                                                                                                                                         │
    return analysis_result.output                                                                                                                                                                                                        │
```                                                                                                                                                                                                                                      │
                                                                                                                                                                                                                                         │
## Observability with Logfire                                                                                                                                                                                                            │
                                                                                                                                                                                                                                         │
```python                                                                                                                                                                                                                                │
import logfire                                                                                                                                                                                                                           │
                                                                                                                                                                                                                                         │
# Configure observability                                                                                                                                                                                                                │
logfire.configure()                                                                                                                                                                                                                      │
logfire.instrument_pydantic_ai()                                                                                                                                                                                                         │
                                                                                                                                                                                                                                         │
# Your agent will now be instrumented                                                                                                                                                                                                    │
agent = Agent(                                                                                                                                                                                                                           │
    'openai:gpt-4o',                                                                                                                                                                                                                     │
    mcp_servers=,                                                                                                                                                                                                                        │
    instrument=True                                                                                                                                                                                                                      │
)                                                                                                                                                                                                                                        │
```                                                                                                                                                                                                                                      │
                                                                                                                                                                                                                                         │
## Complete Example: Context7-Powered AI Agent                                                                                                                                                                                           │
                                                                                                                                                                                                                                         │
```python                                                                                                                                                                                                                                │
import asyncio                                                                                                                                                                                                                           │
import httpx                                                                                                                                                                                                                             │
from dataclasses import dataclass                                                                                                                                                                                                        │
from pydantic_ai import Agent                                                                                                                                                                                                            │
from pydantic_ai.mcp import MCPServerHTTP                                                                                                                                                                                                │
                                                                                                                                                                                                                                         │
@dataclass                                                                                                                                                                                                                               │
class AppDeps:                                                                                                                                                                                                                           │
    http_client: httpx.AsyncClient                                                                                                                                                                                                       │
    context7_key: str                                                                                                                                                                                                                    │
                                                                                                                                                                                                                                         │
async def main():                                                                                                                                                                                                                        │
    # Setup Context7 MCP server                                                                                                                                                                                                          │
    context7_server = MCPServerHTTP(                                                                                                                                                                                                     │
        url='http://localhost:3001/sse',                                                                                                                                                                                                 │
        tool_prefix='context7'                                                                                                                                                                                                           │
    )                                                                                                                                                                                                                                    │
                                                                                                                                                                                                                                         │
    # Create agent with Context7 integration                                                                                                                                                                                             │
    agent = Agent(                                                                                                                                                                                                                       │
        'openai:gpt-4o',                                                                                                                                                                                                                 │
        mcp_servers=,                                                                                                                                                                                                                    │
        deps_type=AppDeps,                                                                                                                                                                                                               │
        system_prompt='You are a helpful assistant with access to Context7 documentation search'                                                                                                                                         │
    )                                                                                                                                                                                                                                    │
                                                                                                                                                                                                                                         │
    async with agent.run_mcp_servers():                                                                                                                                                                                                  │
        async with httpx.AsyncClient() as client:                                                                                                                                                                                        │
            deps = AppDeps(client, 'your-context7-key')                                                                                                                                                                                  │
                                                                                                                                                                                                                                         │
            # Query with Context7 integration                                                                                                                                                                                            │
            result = await agent.run(                                                                                                                                                                                                    │
                'What are the latest best practices for Python async programming?',                                                                                                                                                      │
                deps=deps                                                                                                                                                                                                                │
            )                                                                                                                                                                                                                            │
                                                                                                                                                                                                                                         │
            print("Answer:", result.output)                                                                                                                                                                                              │
            print("Usage:", result.usage())                                                                                                                                                                                              │
                                                                                                                                                                                                                                         │
if __name__ == '__main__':                                                                                                                                                                                                               │
    asyncio.run(main())                                                                                                                                                                                                                  │
```                                                                                                                                                                                                                                      │
                                                                                                                                                                                                                                         │
## Key Features Summary                                                                                                                                                                                                                  │
                                                                                                                                                                                                                                         │
1. **OpenAI Integration**: Full support for GPT-4o, GPT-4o-mini, and other OpenAI models                                                                                                                                                 │
2. **MCP Support**: Native integration with Context7 via MCP protocol                                                                                                                                                                    │
3. **Multiple Transport Options**: HTTP SSE and stdio transport for MCP servers                                                                                                                                                          │
4. **Structured Outputs**: Type-safe responses using Pydantic models                                                                                                                                                                     │
5. **Dependency Injection**: Clean management of external dependencies                                                                                                                                                                   │
6. **Observability**: Built-in Logfire integration for monitoring                                                                                                                                                                        │
7. **Multi-Agent Systems**: Easy chaining and delegation between agents                                                                                                                                                                  │
8. **Tool Prefixing**: Prevent naming conflicts when using multiple MCP servers                                                                                                                                                          │
                                                                                                                                                                                                                                         │
This setup provides a robust foundation for building AI agents that leverage OpenAI's language models while accessing comprehensive documentation through Context7's MCP-based retrieval system. 
